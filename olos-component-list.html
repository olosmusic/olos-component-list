<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-menu-behavior/iron-menu-behavior.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/image-icons.html">

<link rel="import" href="../olos-soundfile/olos-soundfile.html">
<link rel="import" href="../olos-sampler/olos-sampler.html">

<link rel="import" href="../olos-oscillator/olos-oscillator.html">
<link rel="import" href="../olos-analyser/olos-analyser.html">
<link rel="import" href="../olos-spectrograph/olos-spectrograph.html">

<link rel="import" href="../olos-eq/olos-eq.html">
<link rel="import" href="../olos-gain/olos-gain.html">
<link rel="import" href="../olos-delay/olos-delay.html">
<link rel="import" href="../olos-waveshaper/olos-waveshaper.html">
<link rel="import" href="../olos-convolver/olos-convolver.html">


<link rel="import" href="../olos-matrix/olos-matrix.html">
<link rel="import" href="../olos-envelope/olos-envelope.html">

<!--
A list of olos components, fork of lens-component-list

##### Example

    <olos-component-list></olos-component-list>
-->
<dom-module id="olos-component-list" attributes="componentList">

  <template>

    <link rel="stylesheet" type="text/css" href="olos-component-list.css" />
<!--
    <template if="{{componentList.length>0}}">
        <iron-menu-behavior id="component-list">
          <template repeat="{{component in componentList}}">
            <iron-item class="{{component.name}}" on-dragStart="{{dragStartList}}"  draggable="true" label="{{component.friendly || component.name}}"></iron-item>
          </template>
        </iron-menu-behavior>
      </template>
  -->


    <template is="dom-if" if="{{_sortedComponentList.length}}">
     
       <iron-menu-behavior id="component-list">
    
          <template is="dom-repeat" items="{{_sortedComponentList}}" as="category">

            <paper-item class="category" class$="{{ catColorFromCat(category.name) }}" on-click="toggleCategory" __data="{{category.name}}">{{category.name}}</paper-item>
            <iron-collapse id="{{category.name}}">
              <iron-menu-behavior icon="expand-more" label="{{category.name}}">
      
                <template is="dom-repeat" items="{{category.components}}" as="component">
                  <paper-item component-name$="{{component.name}}" class="component-item" on-mouseover="mouseOver" on-dragStart="dragStartList"  draggable="true" >

                  <span class="abrv" class$="{{abrvColorFromCat(component.category)}}">{{component.abrv}}</span><span class="desc">{{ getFriendlyName(component)}}</span>
                 
                  </paper-item>
                
                </template>
      
              </iron-menu-behavior>
            </iron-collapse>
    
          </template>
    
        </iron-menu-behavior>
        
      </template>


  </template>

  <script>

    Polymer({

      is: 'olos-component-list',
      /**
       * Main categories for the menu. Anything other than categories here will be after the main categories in the list
       * @type {Array}
       */
      mainCategories: ['source', 'filter', 'visualize'],
      /**
       * List of components as an array of objects.
       * @type {Array}
       * @example [{"name":"lens-viz-mapbox", "friendly":"Mapbox", "category":"Maps"}]
       */
      componentList: [
                        {
                          name: 'olos-soundfile',
                          friendly: 'Soundfile',
                          abrv: 'sf1',
                          category: 'source'
                        },
                        {
                          name: 'olos-sampler',
                          friendly: 'Sampler',
                          abrv: 'smp',
                          category: 'source'
                        },
                        {
                          name: 'olos-oscillator',
                          friendly: 'Oscillator',
                          abrv: 'osc',
                          category: 'source'
                        },
                        {
                          name: 'olos-analyser',
                          friendly: 'Oscilloscope',
                          abrv: 'osi',
                          category: 'visualize'
                        },
                        {
                          name: 'olos-spectrograph',
                          friendly: 'Spectrograph',
                          abrv: 'spc',
                          category: 'visualize'
                        },
                        {
                          name: 'olos-eq',
                          friendly: 'EQ Filter',
                          abrv: "eq",
                          category: 'filter'
                        },
                        {
                          name: 'olos-gain',
                          friendly: 'Gain',
                          abrv: 'vol',
                          category: 'filter'
                        },
                        {
                          name: 'olos-delay',
                          friendly: 'Delay',
                          abrv: 'dly',
                          category: 'filter'
                        },
                        {
                          name: 'olos-waveshaper',
                          friendly: 'Waveshaper',
                          abrv: 'wvs',
                          category: 'filter'
                        },
                        {
                          name: 'olos-convolver',
                          friendly: 'Convolver',
                          abrv: 'cnv',
                          category: 'filter'
                        },
                        {
                          name: 'olos-matrix',
                          friendly: 'Matrix',
                          abrv: 'mtx',
                          category: 'control'
                        },
                        {
                          name: 'olos-envelope',
                          friendly: 'Envelope',
                          abrv: 'env',
                          category: 'control'
                        }
                      ],
        /**
         * Component list orderes by category
         * @type {Array}
         * @example [{name: 'input', components [{name:'lens-input-csv', friendly: 'CSV Loader', category: 'input'}, ...]}, ...]
         */
        _sortedComponentList: [],

        ready: function() {
          this._sortByCategory();
        },
        /**
         * DragStart event handler sets component name in dataTransfer Object
         * @param  {[type]} e         Event
         * @param  {[type]} detail    Details
         * @param  {[type]} selection Selection
         * @return {[None]}           
         */
        dragStartList: function(e) {
           e.dataTransfer.setData("text/plain", e.target.getAttribute('component-name')); // e.target.classList[0]);

        },
        toggleCategory: function(e) {
          var id = e.target.__data;
          //todo cache
          var collapse = Polymer.dom(this.root).querySelector('#'+id);
          collapse.toggle();
          if(this.openCollapse && this.openCollapse.opened) {
            this.openCollapse.toggle();
            this.openCollapse = null;
          }
          this.openCollapse = collapse;
        },
        /**
         * Checks to see if the custom element is already imported. If not imports it.
         * @param  {DOM}   element  DOM element to check
         * @param  {Function} callback Callback function to call after done
         */
        checkAndImport: function(element, callback) {
          if (element.constructor == HTMLElement) {
            var name = element.tagName.toLowerCase();
            //import on the fly.
            var elInfo = this._findElementInfoByName(name);
	    
	   //assuming lenses-component-list and the lenses are installed in the same directory by bower (which is the defualt)
	   var pathPrefix = this.resolveUrl('lenses-component-list.html').replace('lenses-component-list/lenses-component-list.html','');

	    var path = elInfo.installPath || pathPrefix+name+'/'+name+'.html';
            this.importHref([path], callback);
          }
          else {
            callback();
          }

        },
        /**
         * Returns component info
         * @return {Object} JSON element containing the element info.
         */
        getComponentInfo: function(tagName) {
          return this._findElementInfoByName(tagName);
        },
        getFriendlyName: function(component) {
          return component.friendly || component.name;
        },
        /**
         * Sorts componentList by category
         * @return {[type]} [description]
         */
        _sortByCategory: function() {
          var self = this;

          // create empty categoryList
          self._sortedComponentList = self.mainCategories.map(function(item) {
            return {name: item, components: []};
          });

          self._sortedComponentList = self.componentList.reduce(function(prev, item) {
            var cat = item.category;
            var category = prev.filter(function(item) {
              return item.name === cat;
            });
            if(category.length==0) {
              prev.push({name: cat, components: [item]});
            }
            else {
              category[0].components.push(item);
            }
            return prev;

          }, self._sortedComponentList);

        },
        _findElementInfoByName: function(name) {
          var info = this.componentList.filter(function(item) {
            return item.name===name;
          })
          return info.length>0 ? info[0] : null;
        },
        getColor: function(component) {
          return this.getColorFromCat(component.category);
        },
        getColorFromCat: function(cat) {
          switch(cat){
            case 'visualize':
              return 'color-secondary-1-2';
            case 'filter':
              return 'color-secondary-2-4';
            case 'source':
              return 'color-primary-0';
            case 'control':
              return 'control-color';
            default:
              return '';
              break;
          }
        },
        catColorFromCat: function(cat) {
          return 'category ' + this.getColorFromCat(cat);
        },
        abrvColorFromCat: function(cat) {
          return 'abrv ' + this.getColorFromCat(cat);
        },

        getCategory: function(eltName) {
          var c = this.componentList.filter(function(item) {
            return item.name === eltName;
          });
          console.log(c);
          return c[0].category;
        },
        mouseOver: function(e) {
          // console.log(e);
        }

    });

  </script>

</dom-module>
